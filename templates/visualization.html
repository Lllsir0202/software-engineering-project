<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/icon.png" type="image/x-icon">

    <title>数据可视化平台</title>

    <!-- 样式表 -->
    <link href="https://cdn.bootcss.com/bootstrap/4.1.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <style>
        /* 图表容器样式 */
        .chart-container {
            position: relative;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6c757d;
            font-size: 1.2rem;
            z-index: 10;
        }

        .chart-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #dc3545;
            padding: 1rem;
            text-align: center;
        }

        .chart-img {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .chart-img.loaded {
            opacity: 1;
        }

        /* 用户菜单样式 */
        .user-menu {
            display: flex;
            align-items: center;
            color: #6c757d;
            margin-left: auto;
        }

        .user-name {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 1rem;
        }

        .logout-link {
            color: #6c757d !important;
            transition: color 0.2s;
            padding: 0.5rem;
        }

        .logout-link:hover {
            color: #dc3545 !important;
            text-decoration: none;
        }




/* 指标选择器美化 */
.metric-selector {
    background: linear-gradient(135deg, #f8f9fc 0%, #eef2f7 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #eaeff5;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.metric-selector:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(52, 152, 219, 0.15);
}

.metric-selector label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
    font-size: 1.05rem;
}

.metric-selector .form-select {
    background-color: white;
    border: 1px solid #dce7f3;
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 0.95rem;
    height: 46px;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease;
}

.metric-selector .form-select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    outline: none;
}

.metric-selector .form-select option {
    padding: 8px;
}

.metric-selector .btn-update {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 0;
    font-weight: 600;
    transition: all 0.3s ease;
    height: 46px;
    box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
}

.metric-selector .btn-update:hover {
    background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(52, 152, 219, 0.4);
}

.metric-selector .btn-update:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
}

/* 日期选择器美化 */
.date-selector {
    background: linear-gradient(135deg, #f8f9fc 0%, #eef2f7 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #eaeff5;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.date-selector:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.15);
}

.date-selector label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
    font-size: 1.05rem;
}

.date-selector .form-control {
    background-color: white;
    border: 1px solid #dce7f3;
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 0.95rem;
    height: 46px;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: border-color 0.3s ease;
}

.date-selector .form-control:focus {
    border-color: #2ecc71;
    box-shadow: 0 0 0 0.25rem rgba(46, 204, 113, 0.25);
    outline: none;
}

.date-selector .btn-primary {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 0;
    font-weight: 600;
    transition: all 0.3s ease;
    height: 46px;
    width: 100%;
    box-shadow: 0 4px 6px rgba(46, 204, 113, 0.3);
}

.date-selector .btn-primary:hover {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(46, 204, 113, 0.4);
}

.date-selector .btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(46, 204, 113, 0.3);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .metric-selector, .date-selector {
        padding: 15px;
    }

    .metric-selector .col-md-8,
    .metric-selector .col-md-4,
    .date-selector .col-md-5,
    .date-selector .col-md-2 {
        margin-bottom: 10px;
    }

    .date-selector .col-md-5 {
        margin-bottom: 15px;
    }

    .date-selector .col-md-2 {
        margin-top: 5px;
    }
}
    </style>
</head>

<body>
<!-- 导航栏 -->
<header data-block-type="headers" data-id="1">
    <div class="container-fluid" style="background-color: #e3f2fd;">
        <nav class="navbar navbar-expand-md no-gutters">
            <div class="col-2 text-left">
                <!-- <a href="/"> -->
                <img height="40" alt="数据平台" class="custom-logo">
                <!-- </a> -->
            </div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="collapse navbar-collapse justify-content-center col-md-8" id="navbarNav2">
                    <ul class="navbar-nav">
                        <li class="nav-item active">
                            <a class="nav-link" href="/homepage">首页</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="/dashboard">仪表盘</a></li>
                        <li class="nav-item"><a class="nav-link" href="/datacenter">数据中心</a></li>
                        <li class="nav-item"><a class="nav-link" href="/visualization">分析报告</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin">管理员页面</a></li>
                    </ul>
                </div>

                <!-- 用户状态区域 -->
                <div class="user-menu">
                        <span class="user-name" title="当前用户：{{ session['username'] }}">
                            <i class="fa fa-user-circle-o"></i>
                            {{ session.get('username', '游客') }}
                        </span>
                    <a href="/logout" class="logout-link">
                        <i class="fa fa-sign-out"></i>
                        退出
                    </a>
                </div>
            </div>
        </nav>
    </div>
</header>

<!-- 主内容区 -->
<main class="container-fluid py-5">
    <section class="chart-section">
        <div class="container">
            <div class="row mb-4">
                <div class="col text-center">
                    <h1 class="display-4">数据可视化</h1>
                    <p class="text-muted">实时数据更新：<span id="update-time"></span></p>
                </div>
            </div>

            <!-- 图表行1 -->

            <div class="row">
                <!-- 鱼类数据图保持不变 -->
                <div class="col-lg-6 chart-container">
                    <!-- 指标选择器 -->
                    <div class="metric-selector">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label"><i class="fas fa-chart-line me-2"></i>选择分析指标:</label>
                                <select id="metric-select" class="form-select">
                                    <option value="Height(cm)">高度 (cm)</option>
                                    <option value="Weight(g)">重量 (g)</option>
                                    <option value="Length1(cm)">长度1 (cm)</option>
                                    <option value="Length2(cm)">长度2 (cm)</option>
                                    <option value="Length3(cm)">长度3 (cm)</option>
                                    <option value="Width(cm)">宽度 (cm)</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="update-growth" class="btn btn-update w-100">
                                    <i class="fas fa-sync me-2"></i>更新图表
                                </button>
                            </div>
                        </div>
                    </div>

                    <img id="chart-growth" class="chart-img img-fluid" alt="鱼类数据" data-chart-id="growth"
                         data-src="/api/charts/growth">
                    <div class="chart-loading" id="growth-loading">
                        <i class="fa fa-spinner fa-spin"></i> 加载鱼类数据图...
                    </div>
                </div>

                <!-- 水质数据图添加日期选择器 -->
                <div class="col-lg-6 chart-container">
                    <!-- 日期选择器区域 -->
                    <div class="date-selector mb-3">
                        <div class="row">
                            <div class="col-md-5">
                                <label>起始日期:</label>
                                <input type="date" id="start-date" class="form-control">
                            </div>
                            <div class="col-md-5">
                                <label>终止日期:</label>
                                <input type="date" id="end-date" class="form-control">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="update-chart" class="btn btn-primary">更新</button>
                            </div>
                        </div>
                    </div>

                    <img id="chart-water" class="chart-img img-fluid" alt="水质数据" data-chart-id="water_quality"
                         data-src="/api/charts/water_quality">
                    <div class="chart-loading">
                        <i class="fa fa-spinner fa-spin"></i> 加载水质趋势图...
                    </div>
                </div>
            </div>

            <!--            &lt;!&ndash; 图表行2 &ndash;&gt;-->
            <!--            <div class="row mt-4">-->
            <!--                <div class="col-12 chart-container">-->
            <!--                    <img id="chart-realtime" class="chart-img img-fluid" alt="视频展示" data-chart-id="realtime"-->
            <!--                         data-src="/api/charts/realtime">-->
            <!--                    <div class="chart-loading">-->
            <!--                        <i class="fa fa-spinner fa-spin"></i> 加载实时数据...-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->
        </div>
    </section>
</main>

<!-- 脚本 -->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.1.0/js/bootstrap.bundle.min.js"></script>
<script>
    class ChartLoader {
        constructor() {
            this.charts = document.querySelectorAll('.chart-img');
            this.init();
        }

        init() {
            this.updateTimestamp();
            this.loadCharts();
            this.setupAutoRefresh();
        }

        async loadCharts() {
            for (const chart of this.charts) {
                const container = chart.parentElement;
                const src = chart.dataset.src;
                const chartId = chart.dataset.chartId;

                // 显示加载中
                chart.classList.remove('loaded');
                container.querySelector('.chart-loading').style.display = 'block';

                try {
                    const response = await fetch(`${src}?t=${new Date().getTime()}`);
                    const data = await response.json();

                    if (data.status === "success") {
                        chart.src = data.image;  // base64 图片
                        chart.onload = () => {
                            chart.classList.add('loaded');
                            container.querySelector('.chart-loading').style.display = 'none';
                        };
                    } else {
                        throw new Error(data.message || "图表加载失败");
                    }
                } catch (error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chart-error';
                    errorDiv.innerHTML = `
                <i class="fa fa-exclamation-triangle"></i>
                <p>图表加载失败：${error.message}</p>
                <button class="btn btn-sm btn-outline-secondary"
                        onclick="location.reload()">重试</button>
            `;
                    container.querySelector('.chart-loading')?.remove();
                    container.appendChild(errorDiv);
                }
            }
        }

        updateTimestamp() {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('update-time').textContent =
                new Date().toLocaleString('zh-CN', options);
        }

        setupAutoRefresh() {
            setInterval(() => {
                this.updateTimestamp();
                this.loadCharts();
            }, 60000);  // 每分钟刷新
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        new ChartLoader();
    });

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 设置默认日期
        const today = new Date();
        const defaultStart = '2020-05-08';
        const defaultEnd = '2020-05-31';

        document.getElementById('start-date').value = defaultStart;
        document.getElementById('end-date').value = defaultEnd;

        // 鱼类图表更新函数
        function updateGrowthChart() {
            const metric = document.getElementById('metric-select').value;
            const img = document.getElementById('chart-growth');
            const loading = document.getElementById('growth-loading');

            img.style.display = 'none';
            loading.style.display = 'block';

            const baseUrl = '/api/charts/growth';
            const params = new URLSearchParams({ metric });

            fetch(`${baseUrl}?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        img.src = data.image;
                        img.style.display = 'block';
                    } else {
                        throw new Error(data.message || '图表加载失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(`更新鱼类图表失败: ${error.message}`);
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
        }

        // 水质图表更新函数
        function updateWaterChart() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate || startDate > endDate) {
                alert("请选择有效的日期范围");
                return;
            }

            const [from_year, from_month, from_day] = startDate.split('-');
            const [to_year, to_month, to_day] = endDate.split('-');

            const img = document.getElementById('chart-water');
            const loading = document.getElementById('water-loading');

            img.style.display = 'none';
            loading.style.display = 'block';

            const baseUrl = '/api/charts/water_quality';
            const params = new URLSearchParams({
                from_year,
                from_month,
                from_day,
                to_year,
                to_month,
                to_day,
                position: '鼓楼外大街',
                metrics: '水温'
            });

            fetch(`${baseUrl}?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        img.src = data.image;
                        img.style.display = 'block';
                    } else {
                        throw new Error(data.message || '图表加载失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(`更新水质图表失败: ${error.message}`);
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
        }

        // 绑定事件
        document.getElementById('update-growth').addEventListener('click', updateGrowthChart);
        document.getElementById('update-water').addEventListener('click', updateWaterChart);

        // 初始加载图表
        updateGrowthChart();
        updateWaterChart();
    });
</script>
</body>

</html>